name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop, 'v*' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
        - debug
        - release
      target_platform:
        description: 'Target platform'
        required: true
        default: 'android'
        type: choice
        options:
        - android
        - web
        - all

env:
  FLUTTER_VERSION: '3.24.0'
  JAVA_VERSION: '17'

jobs:
  # 代码质量检查
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze --fatal-infos

    - name: Format check
      run: dart format --set-exit-if-changed .

    - name: Run tests
      run: flutter test --coverage

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info

  # Android 构建
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event.inputs.target_platform == 'android' || github.event.inputs.target_platform == 'all' || github.event.inputs.target_platform == ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: ${{ env.JAVA_VERSION }}

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Install dependencies
      run: flutter pub get

    - name: Build APK (Debug)
      if: github.event.inputs.build_type == 'debug' || github.event.inputs.build_type == ''
      run: |
        flutter build apk --debug --analyze-size
        mkdir -p build/android-apk
        cp build/app/outputs/flutter-apk/app-debug.apk build/android-apk/

    - name: Build APK (Release)
      if: github.event.inputs.build_type == 'release'
      run: |
        flutter build apk --release --analyze-size --shrink
        mkdir -p build/android-apk
        cp build/app/outputs/flutter-apk/app-release.apk build/android-apk/

    - name: Generate build report
      run: |
        echo "# Android Build Report" > build/android-apk/build-report.md
        echo "**Build Type**: ${{ github.event.inputs.build_type || 'debug' }}" >> build/android-apk/build-report.md
        echo "**Flutter Version**: ${{ env.FLUTTER_VERSION }}" >> build/android-apk/build-report.md
        echo "**Build Time**: $(date)" >> build/android-apk/build-report.md
        echo "" >> build/android-apk/build-report.md
        echo "## APK Information" >> build/android-apk/build-report.md
        ls -lh build/android-apk/*.apk >> build/android-apk/build-report.md

    - name: Upload APK artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk-${{ github.event.inputs.build_type || 'debug' }}
        path: build/android-apk/
        retention-days: 30

  # Web 构建
  build-web:
    name: Build Web
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event.inputs.target_platform == 'web' || github.event.inputs.target_platform == 'all'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build web
      run: |
        flutter build web --web-renderer canvaskit
        tar -czf build/web.tar.gz -C build/web .

    - name: Upload web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: build/web.tar.gz
        retention-days: 30

  # 性能测试
  performance-test:
    name: Performance Test
    runs-on: ubuntu-latest
    needs: [build-android]
    if: github.event.inputs.build_type == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Download APK
      uses: actions/download-artifact@v4
      with:
        name: android-apk-release
        path: build/android-apk/

    - name: Setup Android Emulator
      uses: reactivecircus/android-emulator-runner@v2
      with:
        api-level: 29
        target: google_apis
        arch: x86_64
        profile: pixel

    - name: Run performance tests
      run: |
        chmod +x scripts/performance_test.sh
        ./scripts/performance_test.sh build/android-apk/app-release.apk

    - name: Upload performance results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: performance-results/
        retention-days: 30

  # 安全扫描
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Upload Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: 'trivy-results.sarif'

  # 部署到测试环境
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-android, build-web]
    if: github.ref == 'refs/heads/develop' && github.event.inputs.build_type == 'release'
    environment: staging
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment..."
        # 这里添加实际的部署逻辑

  # 创建 Release
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-android, build-web, performance-test]
    if: startsWith(github.ref, 'refs/tags/v') && github.event.inputs.build_type == 'release'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Generate changelog
      run: |
        # 生成变更日志
        echo "## Release Notes" > release-notes.md
        git log --pretty=format:"- %s" $(git describe --tags --abbrev=0 HEAD^)..HEAD >> release-notes.md

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          artifacts/android-apk-release/*.apk
          artifacts/web-build/web.tar.gz
        body_path: release-notes.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}