name: Code Quality Checks

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install clang-format
      run: sudo apt-get install -y clang-format

    - name: Check C++ formatting
      run: |
        find . -name "*.h" -o -name "*.cc" -o -name "*.cpp" -o -name "*.c" | grep -v build/ | xargs clang-format --dry-run --Werror || exit_code=$?
        if [ $exit_code -ne 0 ]; then
          echo "Code formatting issues found!"
          find . -name "*.h" -o -name "*.cc" -o -name "*.cpp" -o -name "*.c" | grep -v build/ | xargs clang-format --dry-run -Werror
          exit 1
        fi

    - name: Install and run CMake linter
      run: |
        pip install cmakelint
        find . -name "CMakeLists.txt" -o -name "*.cmake" | xargs cmakelint || echo "CMake lint issues found, but not failing build"

    - name: Security scan
      run: |
        echo "Running security checks..."
        # Add security scanning tools if available
        git ls-files | grep -E "\.(js|ts|jsx|tsx|py|java|cpp|cc|h)$" | head -20 | while read file; do
          if [ -f "$file" ]; then
            echo "Checking: $file"
          fi
        done