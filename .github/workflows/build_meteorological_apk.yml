name: Build Meteorological Sandbox APK

on:
  push:
    tags:
      - 'v0.0.1'
  workflow_dispatch:
    inputs:
      version:
        description: 'APK version'
        required: false
        default: '0.0.1'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        packages: tools platform-tools build-tools-34.0.0 cmake-3.22.1 ndk-25.2.9519653

    - name: Install dependencies
      run: |
        npm ci
        npm install -g @expo/cli

    - name: Setup Expo CLI
      run: |
        npx expo install --fix

    - name: Configure app version
      run: |
        VERSION="${{ github.event.inputs.version || '0.0.1' }}"
        echo "Building version: $VERSION"
        
        # Update package.json
        jq --arg version "$VERSION" '.version = $version' package.json > package.json.tmp
        mv package.json.tmp package.json
        
        # Update app.json
        jq --arg version "$VERSION" '.expo.version = $version' app.json > app.json.tmp
        mv app.json.tmp app.json
        
        # Update pubspec.yaml
        sed -i "s/version: .*/version: $VERSION+1/" pubspec.yaml
        
        # Update Android build.gradle
        sed -i "s/versionName \".*\"/versionName \"$VERSION\"/" android/app/build.gradle

    - name: Prebuild Android
      run: |
        npx expo prebuild --platform android --clean

    - name: Make gradlew executable
      run: |
        chmod +x android/gradlew

    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          !~/.gradle/caches/build-cache-*
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Build APK
      run: |
        cd android
        ./gradlew assembleRelease --no-daemon
      env:
        JAVA_OPTS: -Xmx2048m
        EXPO_PUBLIC_API_KEY: ${{ secrets.EXPO_PUBLIC_API_KEY }}

    - name: Create APK directory
      run: |
        mkdir -p apk
        cp android/app/build/outputs/apk/release/app-release.apk apk/meteorological-sandbox-v${{ github.event.inputs.version || '0.0.1' }}.apk

    - name: Generate APK Info
      run: |
        VERSION="${{ github.event.inputs.version || '0.0.1' }}"
        APK_FILE="apk/meteorological-sandbox-v$VERSION.apk"
        
        if [ -f "$APK_FILE" ]; then
          APK_SIZE=$(du -h "$APK_FILE" | cut -f1)
          APK_SHA256=$(sha256sum "$APK_FILE" | cut -d' ' -f1)
          
          cat > apk/info.json << EOF
        {
          "version": "$VERSION",
          "filename": "meteorological-sandbox-v$VERSION.apk",
          "size": "$APK_SIZE",
          "sha256": "$APK_SHA256",
          "build_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "workflow": "${{ github.workflow }}",
          "run_id": "${{ github.run_id }}"
        }
        EOF
        fi

    - name: Upload APK to Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: meteorological-sandbox-apk
        path: |
          apk/*.apk
          apk/info.json
        retention-days: 30

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: apk/*.apk
        draft: false
        prerelease: false
        generate_release_notes: true
        name: Meteorological Sandbox v${{ github.event.inputs.version || '0.0.1' }}
        body: |
          ## æ°”è±¡æ²™ç›˜æ¨¡æ‹Ÿå™¨ v${{ github.event.inputs.version || '0.0.1' }}
          
          ### ðŸŒŸ ä¸»è¦ç‰¹æ€§
          - 6ä¸ªä¸“ä¸šæ°”è±¡æ±‚è§£å™¨ï¼ˆé£Žåœºã€æ°´æ±½ã€é™æ°´ã€é”‹é¢ã€è¾å°„ã€è¾¹ç•Œå±‚ï¼‰
          - å¹¶è¡Œè®¡ç®—æ”¯æŒå’Œè‡ªé€‚åº”æ—¶é—´æ­¥é•¿ç®—æ³•
          - å•†ä¸šçº§æ€§èƒ½é…ç½®ç³»ç»Ÿ
          - é«˜çº§å¯è§†åŒ–å’Œåˆ†æžåŠŸèƒ½
          - å“åº”å¼ç”¨æˆ·ç•Œé¢è®¾è®¡
          - å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
          
          ### ðŸ“± æŠ€æœ¯è§„æ ¼
          - æœ€ä½ŽAndroidç‰ˆæœ¬: 5.0 (API 21)
          - ç›®æ ‡Androidç‰ˆæœ¬: 14 (API 34)
          - æ”¯æŒæž¶æž„: arm64-v8a, armeabi-v7a
          - åº”ç”¨å¤§å°: çº¦15MB
          
          ### ðŸš€ å®‰è£…æ–¹æ³•
          1. ä¸‹è½½APKæ–‡ä»¶
          2. åœ¨Androidè®¾å¤‡ä¸Šå¯ç”¨"æœªçŸ¥æ¥æº"å®‰è£…
          3. ç‚¹å‡»APKæ–‡ä»¶è¿›è¡Œå®‰è£…
          4. å¯åŠ¨åº”ç”¨å¼€å§‹æ°”è±¡æ¨¡æ‹Ÿ
          
          ### ðŸ“Š æž„å»ºä¿¡æ¯
          - æž„å»ºæ—¶é—´: $(date -u +%Y-%m-%dT%H:%M:%SZ)
          - æäº¤å“ˆå¸Œ: ${{ github.sha }}
          - æž„å»ºå·¥ä½œæµ: ${{ github.workflow }}
          
          ---
          ç”± iFlow CLI æž„å»º ðŸ¤–
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Print build info
      run: |
        VERSION="${{ github.event.inputs.version || '0.0.1' }}"
        if [ -f "apk/meteorological-sandbox-v$VERSION.apk" ]; then
          APK_SIZE=$(du -h "apk/meteorological-sandbox-v$VERSION.apk" | cut -f1)
          echo "âœ… Build completed successfully!"
          echo "ðŸ“± APK: meteorological-sandbox-v$VERSION.apk"
          echo "ðŸ“ Size: $APK_SIZE"
          echo "ðŸ”— Download from artifacts or releases section"
        else
          echo "âŒ Build failed - APK not found"
          exit 1
        fi